<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Index</title>

        <style>
          /* #plotContainer {
            width: 80%;
            max-height: 300px;
          } */

          canvas{
            /* width:1100px !important;
            height:500px !important; */
            width:1250px !important;
            height:1000px !important;
          }
        </style>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>

        <script>    
             
              var obj_csv = {
                  size:0,
                  dataFile:[]
              };

              function readImage(input) {
                if (input.files && input.files[0]) {               

                  let reader = new FileReader();
                  reader.readAsBinaryString(input.files[0]);
                  reader.onload = function (e) {
                    obj_csv.size = e.total;
                    obj_csv.dataFile = e.target.result
                    parseData(obj_csv.dataFile)          
                  }
                }
              }

              function parseData(data){
                let csvData = [];
                let lbreak = data.split("\n");
                lbreak.forEach(res => {
               
                  if((res.split(",")).length == 7) {
                    csvData.push(res.split(","));
                  }
                  
                });
                localStorage.setItem("fileData", csvData);

              }

            function loadChart(xDatelabels, yStockData) {

              let ctx = document.getElementById('myChart').getContext('2d');
              let myChart = new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: xDatelabels,
                      datasets: [{
                          label: 'Stock price predictions',
                          data: yStockData,
                          fill: false,
                          backgroundColor: 'rgba(255, 99, 132, 0.2)',
                          borderColor: 'rgba(255, 99, 132, 1)',
                          borderWidth: 1
                      }]
                  },
              });
            }

            function load2Charts(xDatelabels, yStockData1, yStockData2) {
              let ctx = document.getElementById('myChart').getContext('2d');
                let myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: xDatelabels,
                        datasets: [
                          {
                            label: "User's model Stock price predictions",
                            data: yStockData1,
                            fill: false,
                            backgroundColor: 'rgba(222, 17, 2, 0.2)',
                            borderColor: 'rgba(222, 17, 2, 1)',
                            borderWidth: 1
                          },
                          {
                            label: "Software's model Stock price predictions",
                            data: yStockData2,
                            fill: false,
                            backgroundColor: 'rgba(45, 5, 227, 0.2)',
                            borderColor: 'rgba(45, 5, 227, 1)',
                            borderWidth: 1
                          }
                      ]
                    },
                });
            }

            $(document).ready(function(){

                // $("#uploadData").click(function(){           
                  
                //   let stockFile = localStorage.getItem("fileData");          
                //   oneDArray = stockFile.split(",")          
                //   var twoDArray = [], size = 7;               
                //   while (oneDArray.length > 0)
                //     twoDArray.push(oneDArray.splice(0, size));          

                //   stockData = twoDArray
                //   console.log("Data sent!")
                //   $.ajax({
                //     url:"/stockDataFile/"+stockData,
                //       success: function(dataDict){

                //         message = dataDict['message']
                //         predictedData = dataDict['predictedData']
                //         testData = dataDict['testData']
                //         dateRange = dataDict['dateRange']
                //         dataLength = dataDict['dataLength']

                //         console.log(message);
                //         console.log(predictedData[0][0])
                //         console.log(dateRange[0])

                //         chartData = []

                //         for (i = 0; i < predictedData.length; i++) {
                //           chartData.push(predictedData[i][0])
                //         }

                //         loadChart(dateRange.slice(0, 150), chartData.slice(0, 150))
                //       }
                //   })
                // });

                $('#upload-CSV-file-btn').click(function() {
                  var form_data = new FormData($('#upload-csv')[0]);
                  $.ajax({
                      type: 'POST',
                      url: '/uploadCSV',
                      data: form_data,
                      contentType: false,
                      cache: false,
                      processData: false,
                      success: function(dataDict) {
                          message = dataDict['message']
                          predictedData = dataDict['predictedData']
                          testData = dataDict['testData']
                          dateRange = dataDict['dateRange']
                          dataLength = dataDict['dataLength']                      

                          chartData = []

                          for (i = 0; i < predictedData.length; i++) {
                            chartData.push(predictedData[i][0])
                          }

                          loadChart(dateRange.slice(0, 150), chartData.slice(0, 150))
                      },
                  });
                });

                $('#upload-h5-file-btn').click(function() {
                  var form_data = new FormData($('#upload-file')[0]);
                  $.ajax({
                      type: 'POST',
                      url: '/uploadajax',
                      data: form_data,
                      contentType: false,
                      cache: false,
                      processData: false,
                      success: function(dataDict) {
                          console.log('Success!');

                          predictedData = dataDict['predictedData']
                          myModelPredictedData = dataDict['myModelPredictedData']
                          dateRange = dataDict['dateRange']

                          chartData1 = []
                          chartData2 = []

                          for (i = 0; i < predictedData.length; i++) {
                            chartData1.push(predictedData[i][0])
                            chartData2.push(myModelPredictedData[i][0])
                          }

                          load2Charts(dateRange.slice(0, 150), chartData1.slice(0, 150), chartData2.slice(0, 150))
                      },
                  });
                });
            });
        </script>

    </head>

    <body>
        <h1 style="color: blue">Index</h1>
        <p>This is an HTML file served up by Flask</p>
        
        <!-- <input type="file" name="file" accept=".csv" id="stockData"  onChange="readImage(this)">
        <input type="submit" value="Upload CSV data" id="uploadData"> -->


        <form id="upload-csv" method="post" enctype="multipart/form-data">
          <fieldset>
              <label for="file">Select a CSV file</label>
              <input name="CSVfile" type="file">
          </fieldset>
          <fieldset>
              <button id="upload-CSV-file-btn" type="button">Upload</button>
          </fieldset>
        </form>

        <form id="upload-file" method="post" enctype="multipart/form-data">
          <fieldset>
              <label for="file">Select a h5 file</label>
              <input name="file" type="file">
          </fieldset>
          <fieldset>
              <button id="upload-h5-file-btn" type="button">Upload</button>
          </fieldset>
        </form>

        <div id="plotContainer" class="container">
            <canvas id="myChart" width="300" height="300"></canvas>
        </div>

    </body>

</html>